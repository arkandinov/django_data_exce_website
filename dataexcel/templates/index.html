<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Data Excel</title>

    <!-- Load Bootstrap (CSS + JS) -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Optional: jQuery (required if kamu pakai Select2 atau AJAX) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Select2 (jika kamu pakai plugin ini untuk filter dropdown) -->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <style>
      body {
        display: flex;
        justify-content: center;
        padding-top: 30px;
      }
      tfoot select {
        width: 100%;
      }
      /* Lebar khusus untuk select invoice */
      tfoot th:nth-child(1) select {
        min-width: 150px;
      }

      /* Warna kuning untuk pilihan yang dipilih */
      .select2-container--default
        .select2-selection--multiple
        .select2-selection__choice {
        background-color: yellow;
        color: black;
        font-weight: bold;
      }

      tr,
      th {
        border: 1px solid black;
        width: auto;
        text-size-adjust: auto;
      }
    </style>
  </head>

  <body>
    <div class="tab-pane fade show active p-3" id="spm1">
      {% csrf_token %}
      <button id="loadDataBtn" class="btn btn-primary">Process Data</button>
      <table id="mytable" class="table">
        <thead>
          <tr>
            <th>No Invoice</th>
            <th>Nama Klien</th>
            <th>Tgl Invoice</th>
            <th>Tgl Klien Terima Invoice</th>
            <th>Total Tagihan</th>
            <th>Tgl Pelunasan</th>
            <th>Total Pelunasan</th>
            <th>Sisa Tagihan</th>
            <th>Tgl Jatuh Tempo</th>
            <th>Tanggal SPM1</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div
      class="modal fade"
      id="filterModal"
      tabindex="-1"
      aria-labelledby="filterModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="filterForm">
            <div class="modal-header">
              <h5 class="modal-title" id="filterModalLabel">Filter</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
              ></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="column" id="filterColumn" />
              <div class="mb-3">
                <label for="filterValue" class="form-label"
                  >Masukkan Nilai</label
                >
                <input
                  type="text"
                  class="form-control"
                  id="filterValue"
                  name="value"
                />
              </div>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-primary">
                Terapkan Filter
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css"
    />
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/id.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />

    <script>
      $(document).ready(function () {
        const table = $("#mytable").DataTable({
          searching: false,
        });
      });
      function loadTable(data) {
        $("#mytable").DataTable().clear().destroy();

        $("#mytable").DataTable({
          data: data,
          columns: [
            { data: "No_Invoice" },
            { data: "Nama_Klien" },
            {
              data: "tgl_Invoice",

              render: function (data, type, row) {
                if (!data) {
                  return "";
                }
                if (type === "display" || type === "filter") {
                  // Pisahkan dan ubah ke format Date
                  const [day, month, year] = data.split("-");
                  const d = new Date(`${year}-${month}-${day}`);
                  return d.toLocaleDateString("id-ID", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
                }
                return data;
              },
            },
            {
              data: "tgl_klien_Terima_Invoice",

              render: function (data, type, row) {
                if (!data) {
                  return "";
                }
                if (type === "display" || type === "filter") {
                  // Pisahkan dan ubah ke format Date
                  const [day, month, year] = data.split("-");
                  const d = new Date(`${year}-${month}-${day}`);
                  return d.toLocaleDateString("id-ID", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
                }
                return data;
              },
            },
            { data: "Total_Tagihan" },
            {
              data: "tgl_Pelunasan",
              render: function (data, type, row) {
                if (!data) {
                  return "";
                }
                if (type === "display" || type === "filter") {
                  // Pisahkan dan ubah ke format Date
                  const [day, month, year] = data.split("-");
                  const d = new Date(`${year}-${month}-${day}`);
                  return d.toLocaleDateString("id-ID", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
                }
                return data;
              },
            },
            { data: "Total_Pelunasan" },
            { data: "Sisa_Tagihan" },
            {
              data: "Tgl_Jatuh_Tempo",
              render: function (data, type, row) {
                if (!data) {
                  return "";
                }
                if (type === "display" || type === "filter") {
                  // Pisahkan dan ubah ke format Date
                  const [day, month, year] = data.split("-");
                  const d = new Date(`${year}-${month}-${day}`);
                  return d.toLocaleDateString("id-ID", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
                }
                return data;
              },
            },
            {
              data: "tanggal_SPM1",
              render: function (data, type, row) {
                if (!data) {
                  return "";
                }
                if (type === "display" || type === "filter") {
                  // Pisahkan dan ubah ke format Date
                  const [day, month, year] = data.split("-");
                  const d = new Date(`${year}-${month}-${day}`);
                  return d.toLocaleDateString("id-ID", {
                    day: "numeric",
                    month: "long",
                    year: "numeric",
                  });
                }
                return data;
              },
            },
          ],
        });
      }

      $(document).ready(function () {
        $("#loadDataBtn").on("click", function () {
          $.ajax({
            url: "/process-data/",
            type: "GET",
            success: function (response) {
              loadTable(response);
            },
            error: function (xhr) {
              alert("Gagal memuat data awal: " + xhr.responseText);
            },
          });
        });
      });
    </script>
  </body>
</html>
